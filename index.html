<!doctype html>
<html lang="bg">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Деба</title>
<meta name="robots" content="noindex, nofollow" />

<style>
:root{
  --bg:#D6E0AC;
  --pink: rgba(220, 120, 190, 0.78);
}

body{
  margin:0;
  height:100vh;
  background:var(--bg);
  overflow:hidden;
  font-family:system-ui,sans-serif;
}

/* LOGO */
#top{
  position:absolute;
  top:20px;
  left:0; right:0;
  display:flex;
  justify-content:center;
  z-index:3;
}
#debaLogo{
  width:min(720px,88vw);
  user-select:none;
  -webkit-user-drag:none;
}

/* TEXT WINDOW (CLIPPED BELOW LOGO) */
#middle{
  position:absolute;
  left:0; right:0;
  bottom:0;
  overflow:hidden;
  pointer-events:none;
  z-index:2;
}

#crawlWrap{
  position:absolute;
  left:0; right:0;
  bottom:0;
  display:flex;
  justify-content:center;
  transform: translateY(110%);
  opacity:0;              /* start hidden */
  transition: opacity 2.2s ease; /* gradual start */
}

#crawlWrap.show{
  opacity:1;
}

.crawl{
  width:min(900px,92vw);
  color:var(--pink);
  font-size:clamp(15px,2vw,24px);
  font-weight:650;
  line-height:1.6;
  text-align:center;
  white-space:pre-line;
  text-shadow:
    0 1px 0 rgba(0,0,0,0.05),
    0 0 10px rgba(180,70,150,0.16);
}

/* STATUS */
#status{
  position:fixed;
  bottom:10px;
  left:10px;
  font-size:12px;
  opacity:.7;
  padding:6px 8px;
  border-radius:10px;
  background:rgba(255,255,255,0.25);
  backdrop-filter: blur(8px);
  z-index:5;
}

/* UWU OVERLAY */
#uwu{
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  font-size:32px;
  font-weight:900;
  color:rgba(40,40,40,0.82);
  cursor:pointer;
  z-index:10;
  user-select:none;
}
</style>
</head>

<body>

<div id="top">
  <img id="debaLogo" src="assets/deba.png" alt="Деба">
</div>

<div id="middle">
  <div id="crawlWrap">
    <div class="crawl" id="crawlText"></div>
  </div>
</div>

<div id="status">loading…</div>
<div id="uwu">~ UwU ~</div>

<audio id="bgm" src="assets/music.mp3" loop preload="auto"></audio>

<script>
const audio = document.getElementById("bgm");
const uwu = document.getElementById("uwu");
const statusEl = document.getElementById("status");
const crawlText = document.getElementById("crawlText");
const crawlWrap = document.getElementById("crawlWrap");
const middle = document.getElementById("middle");
const logo = document.getElementById("debaLogo");

audio.volume = 1.0;

let textReady = false;
let audioReady = false;
let running = false;

let durationMs = 203000; // fallback
let raf = null;
let startTime = 0;

function setMiddleTop(){
  const r = logo.getBoundingClientRect();
  middle.style.top = `${r.bottom + 20}px`;
}

/* Load text from assets/text.txt */
fetch("assets/text.txt")
  .then(r => r.text())
  .then(t => {
    crawlText.textContent = t.trim();
    textReady = true;
    statusEl.textContent = "text ok";
    maybeStart();
  })
  .catch(() => {
    crawlText.textContent = "failed to load assets/text.txt";
    textReady = true;
    maybeStart();
  });

/* Wait for real audio duration */
audio.addEventListener("loadedmetadata", ()=>{
  if (isFinite(audio.duration) && audio.duration > 1) {
    durationMs = audio.duration * 1000;
  }
  audioReady = true;
  maybeStart();
});

function startCrawlSynced(){
  cancelAnimationFrame(raf);
  setMiddleTop();

  // force layout so heights are correct
  const winH = middle.getBoundingClientRect().height;
  const textH = crawlText.getBoundingClientRect().height;

  const startY = winH + 20;
  const endY   = -textH - 40;

  // gradual reveal
  crawlWrap.classList.remove("show");
  crawlWrap.style.transform = `translateY(${startY}px)`;

  // sync to audio: startTime tracks the same timeline as audio currentTime
  // if audio is at 0.0 it starts from the bottom; if not, it resumes correctly
  startTime = performance.now() - (audio.currentTime * 1000);

  // fade in after a tiny delay so it feels like “starts gradually”
  setTimeout(()=> crawlWrap.classList.add("show"), 80);

  function step(now){
    // progress based on audio time so it stays locked even if browser stutters
    const tMs = (audio.currentTime * 1000) % durationMs;
    const p = tMs / durationMs;

    const y = startY + (endY - startY) * p;
    crawlWrap.style.transform = `translateY(${y}px)`;

    raf = requestAnimationFrame(step);
  }
  raf = requestAnimationFrame(step);
}

function maybeStart(){
  if (running) return;
  if (!textReady) return;

  // We only start the crawl when audio is actually playing.
  // If autoplay is blocked, you’ll see UwU.
  tryPlay();
}

async function tryPlay(){
  if (running) return;

  try{
    await audio.play();
    uwu.style.display = "none";
    statusEl.textContent = "music on";
    running = true;

    // Only now start crawl (synced)
    startCrawlSynced();
  }catch{
    uwu.style.display = "flex";
    statusEl.textContent = "tap UwU";
  }
}

/* UwU is the unlock */
uwu.addEventListener("pointerdown", tryPlay);
window.addEventListener("keydown", tryPlay);
window.addEventListener("pointerdown", tryPlay, { once:true });

/* Keep it aligned */
window.addEventListener("resize", ()=>{
  setMiddleTop();
  if (running) startCrawlSynced();
});

document.addEventListener("visibilitychange", ()=>{
  if (!document.hidden && audio.paused) {
    running = false;
    tryPlay();
  }
});

/* Init */
window.addEventListener("load", ()=>{
  setMiddleTop();
  // even if metadata isn't ready yet, tryPlay will run;
  // crawl waits for audio actually playing
  tryPlay();
});
</script>

</body>
</html>
